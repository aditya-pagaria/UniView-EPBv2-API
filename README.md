# Backup Asset Fetcher & Email Notifier

This project automates fetching backup asset data from a remote API and sending formatted CSV reports to any configured recipient.
It consists of two scripts:

1. **`API.py`** – Fetches asset data from an API, normalizes it, writes it to `artifact/assets_rows.json`, and triggers the notifier.
2. **`send_asset_email.py`** – Reads the autogenerated if non-existent JSON, builds a assets_state containing time epoch and ID, builds a CSV, and sends it via SMTP (or simulates the send if in dry-run mode) if it is the first run of the day as defined in send_asset_email ln 282.
If it is any run but the first of the day, it will compare assets_rows and assets_state, rebuild the csv with only the updated assets and sends it via SMTP

---

## Features

- Secure API token handling (client credentials grant)
- Configurable via environment variables or `artifact/config.json`
- Dry-run and live email modes
- Smart incremental vs full CSV sends
- Persistent state tracking to detect changed assets
- Human-readable logs and artifact outputs (all ignored by git)

---

## Project Structure
```
project_root/
│
├── API.py
├── send_asset_email.py
├── artifact/
│ ├── config.json # Local config (not tracked by git)
│ ├── config.example.json # Safe example config (tracked)
│ ├── assets_rows.json # Fetched assets (autogenerated if non-existent)
│ ├── assets_state.json # Internal state (autogenerated if non-existent)
│ ├── current_assets.csv # Latest CSV report (autogenerated if non-existent)
│ ├── send.log # Email send logs (autogenerated if non-existent)
│ └── API-YYYY-MM-DD.log # Daily fetch logs (autogenerated if non-existent)
└── README.md
```

---

All generated data, logs, and real config files are ignored by git as defined in .gitignore

---

## Configuration

The scripts read configuration values from either:

1. `artifact/config.json` (preferred, not committed), **or**
2. Environment variables.

A safe template is provided as `artifact/config.example.json`. All the fields in the config.json file are required but some have default fallbacks set up in the scripts.

---

## How it works

1. API.py authenticates using the configured OAuth client credentials.
2. It fetches the asset list, normalizes the data, and writes artifact/assets_rows.json.
3. It then automatically calls send_asset_email.py (the notifier).
4. send_asset_email.py loads the JSON, generates a state json containing epoch data and does one of the following:
    a. If DRY_RUN is set to true, it will simulate and never send emails.
    b. If SAMPLE_COUNT is set to 0, it will process all assets, else it will process N number of assets if SAMPLE_COUNT = int(cfg("SAMPLE_COUNT", "N"))
    c. Full report at a scheduled time (default: 21:00 UTC). This will send a full report irrespective of the assets_state and assets_rows comparision
    d. Incremental report if assets changed since last send.

---

## Running the scripts

1. Clone to repository or download the ZIP file and extract it.
2. Build your /artifact/config.json file with required data
3. Run with python3 API.py 
    a. It will autostart send_asset_email.py as a subprocess.

---

## Maintenance

- Logs are written daily to /artifact, clean these up periodically or setup a script to compress/delete them on scheduled

---

## License

MIT License © 2025 
Feel free to use and modify, but do not include any real credentials or customer data in public repositories.

---

## Author Notes

This repository was designed with security-first principles:
- No secrets hardcoded in code
- All sensitive data isolated in artifact/
- Defaults are safe (dry-run enabled)
- Compatible with GitHub secret scanning and pre-commit tools

---